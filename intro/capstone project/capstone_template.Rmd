---
title: "Exploring the BRFSS data"
output: 
  html_document: 
    fig_height: 4
    highlight: pygments
    theme: spacelab
---

## Setup

### Load packages

```{r load-packages, message = FALSE}
library(ggplot2)
library(dplyr)
```

### Load data

Make sure your data and R Markdown files are in the same directory. When loaded
your data file will be called `brfss2013`. Delete this note when before you submit 
your work. 

```{r load-data}
load("capstone_data.RData")
data <- brfss2013
```

* * *

## Part 1: Data

The `BRFS` dataset contains `491775` observations with `330` variables of different types - numerical(both discrete and continuous) and categorical(both normal and ordinal). It represents an `observational` `retrospective` study that was conducted in all US states, the District of Columbia and three U.S. territories, thus the population of interest is `US residents over 18 y.o.`. The `subject of interest` is `health-related risk behaviors, chronic health conditions, and use of preventive services` (cite: https://www.cdc.gov/brfss/about/index.htm). The data is collected thru in-house interviews as well as home and cell phone calls, the telephone numbers are obtained through `random-digit` dialing which mean that the dataset can be considered as `representative` of the entire population of US adult citizens. Nonetheless, it can have few sources of bias:

- `Non-response bias` - conducting `phone interviews` implies that significant `non-random` fraction of the randomly sampled people can refuse to take part in the survey (busy people) or not be able to answer the landline call due to being at work.
- `Convenience sample bias` - individuals who are easily accessible are more likely to be included in the sample, for instance, old people that are often at home are more likely to answer the landline phone call (or more agile/friendly people among a family are more likely to pick up the phone/willing to take part).
- `Voluntary response bias` - older/less healthy people have a stronger opinion over their health conditions compared to young/healthy ones.
- `Funding bias` - the CDC(Centers for Disease Control and Prevention) provides two types of funding: acquisition and assistance which may lead to a selection of outcomes, test samples, or test procedures that favor a study's financial sponsor ([link](https://www.cdc.gov/funding/AboutCDCFunding.html)).

Taking in an account these potential sources of bias, the CDC is using the `iterative proportional fitting or ranking` methodology to `weight` the `BRFSS` data. This reduces the potential for bias and increases the representativeness of estimates. The weighting methodology allows for incorporation of a now-crucial variable - telephone ownership(landline/cell phone) into the weighting process. The `age`, `sex`, `categories` of `ethnicity`, `geographic regions within states`, `marital status`, `education level`, `home ownership` and `type of phone ownership` are used to weight BRFSS data. [1: CDC website - dropdown 15.](https://www.cdc.gov/brfss/about/brfss_faq.htm).

Since this is an `observational` study, it cannot be used for `causation` inference as it can only show a `correlation` between variables. The study does use `random sampling` to be representative over entire US population but for causation inference we need `random assignment` in a well-controlled experiment.

Let's take a closer look on the dataset, the variables descriptions could be found in [Calculated Variables in Data Files[PDF - 421 KB]](https://www.cdc.gov/brfss/annual_data/2013/pdf/codebook13_llcp.pdf) file on the CDC website.

```{r data-explore-1}
head(data, n = 5)
```

```{r data-explore-2}
str(data)
```

Let's take few random variables for analysis.

### genhlth - General health

From the `Codebook report` file:

```
General Health
Section: 1.1 Health Status Type: Num
Column: 80 SAS Variable Name: GENHLTH
Prologue:
Description: Would you say that in general, your health is:
Weighted
Value Label Frequency Percentage Percentage
1 Excellent 85,532 17.39 18.66
2 Very good 159,104 32.35 31.68
3 Good 150,548 30.61 31.11
4 Fair 66,700 13.56 13.31
5 Poor 27,909 5.68 4.76
7 Don’t know/Not Sure 969 0.20 0.18
9 Refused 1,004 0.20 0.29
BLANK Not asked or Missing 7 
```

From the log above, `genhlth  : Factor w/ 5 levels "Excellent","Very good",..: 4 3 3 2 3 2 4 3 1 3 ...`,
we can see that the variable is a `Factor` with `5` levels (`ordinal categorical`) of `"Excellent", "Very Good", "Good", "Fair" and "Poor"`, in addition to that there are some missed(`NA`), `refused` or `don't know/not sure` values(`1985` values out of `491775` => about `0.00403639876` percent):

```{r}
data %>% group_by(genhlth) %>% summarise(n = n())
```

This is an interesting variable as it indicates `subjective` general health rating of a respondent and can be used in correlational exploratory data analysis with many variables.

### sleptim1 - How much time do you sleep

From the `Codebook report` file:

```
How Much Time Do You Sleep
Section: 4.1 Inadequate Sleep Type: Num
Column: 91-92 SAS Variable Name: SLEPTIM1
Prologue: I would like to ask you about your sleep pattern.
Description: On average, how many hours of sleep do you get in a 24-hour period?
Weighted
Value Value Label Frequency Percentage Percentage
1 - 24 Number of hours [1-24] 484,401 98.50 98.76
77 Don’t know/Not Sure 6,540 1.33 1.09
99 Refused 832 0.17 0.15 
```

From the log above, `$ sleptim1 : int  NA 6 9 8 6 8 7 6 8 8 ...`, we can see that the variable is a `discrete numerical` variable (int) from `0` to `24` that represents how much on average `subjectively` does a responded sleep in a `24h` period. There are two observations with corrupted data - `103` and `403` which makes no sense since the top possible number in a day period is `24` (page 3 of the table below). The `Don’t know/Not Sure` (6,540) and `Refused` combined into observations with `NA` values about `.17` percent (`.15` percent weighted). Besides the fact that the long sleep (over 15 hours) might be a legit answer, the naked truth might be different since no human can sleep that long `on average`, we can suspect that some of the `respondent biases` involved.

```{r}
data %>% group_by(sleptim1) %>% summarise(n = n())
```

Looking further into the issue, we can see that the long-sleeping answers take less then `0.0022` which is `0.22` percent (`1066 / (483322 + 1066)`):

```{r}
data %>% filter(!is.na(sleptim1)) %>% mutate(sleep2 = ifelse(sleptim1 < 15, "norm", "many")) %>% group_by(sleep2) %>% summarise(n = n())
```

This variable is interesting for us since an amount of sleep might have a tremendous impact on `objective` and `subjective` health of a human being, thus would be interesting to explore the correlation between sleep and other variables. Also, some habits, especially the ones that involve consuming different substances (tobacco, alcohol, drugs) might have energizing effect thus we might see a correlation with such variables.

### misnervs - How often feel nervous past 30 days

From the `Codebook report` file:

```
How often feel nervous past 30 days
Module: 17.1 Mental Illness & Stigma Type: Num
Column: 418 SAS Variable Name: MISNERVS
Prologue:
Description: About how often during the past 30 days did you feel nervous- would you say all of the time, most of the time, some
of the time, a little of the time or none of the time?
Weighted
Value Value Label Frequency Percentage Percentage
1 All 715 2.15 2.90
2 Most 1,129 3.40 4.05
3 Some 4,675 14.08 14.53
4 A little 9,636 29.01 28.34
5 None 16,056 48.35 45.19
7 Don’t know/Not sure 113 0.34 0.24
9 Refused 887 2.67 4.76
BLANK Not asked or Missing 458,562 
```

```{r}
str(data$misnervs)
```

From the log above, `Factor w/ 5 levels "All","Most","Some",..: 3 4 5 4 NA NA NA NA NA NA ...`, we can see that the variable is a `categorical ordinal` variable (Factor) with levels "All", "Most", "A little" and "None" which represents a subjective respondent nervous feeling past `30 days`. The majority of the observations (about `92.65%`) are `Don’t know/Not sure`, `Refused` and missed(`NA`) values:

```{r}
data %>% group_by(misnervs) %>% summarize(n = n()/nrow(data))
```

This variable might be interesting for us to try to find correlations with a `mental load` and `mental health` of the population. Also, we can try to find a correlation between the `physical health` and the `feeling nervous`(mental health) variables.

* * *

## Part 2: Research questions

Now, when we understood what some of the variables are and what they may imply, we can start asking research questions.

**Research question 1:**

> Are the people who less `physical active` (exerany2) have more chance to `feeling restless`(misrstls)? (2 variables)

The research question can be interesting for finding a correlation between physical activity level and mental issues. The question is of interest for the author of the research because he often `feels restless` too.

**Research question 2:**

> Do `veterans`(veteran3) that are `employed` (employ1) are alos less `feel depressed`(misdeprd)?

Veterans rehabilitation and integration is a big challenge for the society. The research question can reveal if veterans occupation correlate with how well they do in a rehabilitation process.

**Research question 3:**

> Are people who eat`fruits`(fruit1) or `dark vegetables`(fvgreen) are also have better `general health`(genhlth)?

The research question can be interesting to bast/confirm a common myth (or not myth) that eating a lot of fruits/vegetables is good for  human's health. If we will not find any correlation this will mean that the variables might be independent. In the case, if the correlation is found this might suggest that the myth tells truth. In any case, further exploration with a controlled experiment will be needed, which will infer variables dependence or independence (causation).

* * *

## Part 3: Exploratory data analysis

**Research question 1:**

> Are the people who less `physical active` (exerany2) have more chance to `feeling restless`(misrstls)? (2 variables)

Let see what data do we have:

```{r}
data %>% group_by(exerany2) %>% summarize(n = n())
data %>% group_by(misrstls) %>% summarize(n = n())
```

We can see that we have two categorical variables:
  
  - `physical activity` is the variables with `5` levels - `Yes` and `No`.
  - `feeling restless` is the variables with `5` levels - `All`, `Most`, `Some`, `A little` and `None`.

Both of them have some fraction of `NA` observations. Let's filter out them for the sake of convinience:

```{r}
data1 <- data %>% filter(!is.na(misrstls), !is.na(exerany2));
data1 %>% group_by(misrstls, exerany2) %>% summarize(n = n())
```

Lets build a segmeted stardantized barplot with proportions of observations in variaous categories:

```{r}
ggplot(data = data1, aes(x = misrstls, fill = exerany2)) + geom_bar(position = "fill") +
  labs(title="Proportions of people who has physical activity and feeling restless:") +
  xlab("# of days feeling restless (misrstls)") +
  ylab("physical activity (exerany2)") +
  scale_fill_discrete(name = "Physical active")
```

The difference in percentage of different levels might suggest correlation between the variables. We can notice that levels `All`/`Most` and `Some`/`Little` might have a subtle differences in their meaning and can be confused by the respondents. Let's create a new variable and merge these paired levels:

```{r}
# create new data frame with a new Factor `misrstls2` - represent merged categories in pairs:
#   - ("All" or "Most") -> "A lot"
#   - ("Some" or "A little" or "None") -> "A little or none"
data2 <- data1 %>% mutate(misrstls2 = ifelse((misrstls == "All" | misrstls == "Most"), "A lot", "A little or none"))
# group the new dataframe by new variable and summarise it
data2 %>% group_by(misrstls2) %>% summarize(n = n())

# use the new variable with two levels to plot the same standartized barplot
ggplot(data = data2, aes(x = misrstls2, fill = exerany2)) + geom_bar(position = "fill") +
  labs(title="Proportions of people who has physical activity and feeling restless (2 levels):") +
  xlab("# of days feeling restless (misrstls2)") +
  ylab("physical activity (exerany2)") +
  scale_fill_discrete(name = "Physical active")
```

Percentage of people that are physically active and feel restless if about `12.5%` smaller compared to ones that are not physically active. The difference is significantly large, thus cannot happen by chance in such a big sample (~35000 observations). This fact increases our confidence in variables correlation.

#### Recap

In the data exploration above we have found a strong correlation between `physical activity` and `feeling restless` variables. If we take a random person from the people that are physically active, there is ~`12.5%` more chances that he is not feeling restless.

**Research question 2:**

> Do `veterans`(veteran3) that are `employed` (employ1) are alos less `feel depressed`(misdeprd)?

LEt's see what data do we have:

```{r}
data %>% group_by(veteran3) %>% summarize(n = n())
data %>% group_by(employ1) %>% summarize(n = n())
data %>% group_by(misdeprd) %>% summarize(n = n())
```

As we can see we have 3 categorical variables, only the `misdeprd` is `ordinal`. All of the variables have some fraction on `NA` values,
let's filter them out for the sake of convinience, also since we are interested only in veterans, let's filter out all other observations:

```{r}
data_veterans <- data %>% filter(!is.na(veteran3), veteran3 == 'Yes', !is.na(employ1), !is.na(misdeprd))

data_veterans %>% group_by(veteran3) %>% summarize(n = n())
data_veterans %>% group_by(employ1) %>% summarize(n = n())
data_veterans %>% group_by(misdeprd) %>% summarize(n = n())
```

Also we can notice tht the `employ1` have multiple levels to describe a type of `unemployement`, let create a new variable with just `2` levels - `working` and `not working`:

```{r}
data_veterans_empl <- data_veterans %>% mutate(employ1Cat = ifelse((employ1 == 'Employed for wages' | employ1 == 'Self-employed'), 'working', 'not working'))
```

Finally, lets create a standartized barplot for the veterans employement/feeling depressed categories:

```{r}
ggplot(data = data_veterans_empl, aes(x = employ1Cat, fill = misdeprd)) + geom_bar(position = "fill")
```

The variables seem to have some correlations but since the `Feel depressed - None` level takes almost entire bar it is hard to spot it. Let's rephrase our question - "Among the veterans that have signs of depression what fractions are fall into `not working` and `working` categories?", to answer this question let's remove all `Feel depressed - None` levels and create the standartised barplot again:

```{r}
data_veterans_empl_depr <- data_veterans_empl %>% filter(misdeprd != 'None')
ggplot(data = data_veterans_empl_depr, aes(x = employ1Cat, fill = misdeprd)) + geom_bar(position = "fill")
```

As we can see, the level of depression varies among the `not working` and `working` levels, the most significant difference can be spotted for the `A little` (`11%`) and `Most` (`9%`) levels. With a moderate confidence, we can state a correlation.

#### Recap

As we saw, the majority of veterans ~`90%` does not feel depressed at all, besides that fact we have found that there is indeed some correlation between `veteran occupation status` and `depression levels` thus veterans that are not employed are more likely to feel depressed.

**Research question 3:**

> Are people who eat`fruits`(fruit1) or `dark vegetables`(fvgreen) are also have better `general health`(genhlth)?

Let see what data do we have:

```{r}
data %>% group_by(fruit1) %>% summarize(n = n())
data %>% group_by(fvgreen) %>% summarize(n = n())
data %>% group_by(genhlth) %>% summarize(n = n())
```

As we can see, the `general health`(genhlth) is the only categorical(ordinal) variable among 3, the `fruit1` and `fvgreen` are variables of discrete numerical type (integers). All of them have `NA` variables, let's get rid of them:

```{r}
data_fruit <- data %>% filter(!is.na(genhlth), !is.na(fruit1), !is.na(fvgreen))
cat(sprintf("%f observations survived - %f percent", nrow(data_fruit), (nrow(data_fruit) / nrow(data))*100) )
```

Let's look into how the data encoded in the `fvgreen` variable:

```
101 - 199 Times per day 86,099 18.54 18.49
201 - 299 Times per week 163,664 35.25 35.69
301 - 399 Times per month 168,235 36.23 34.79
1 Less than one time per month 2,141 0.46 0.34
0 Never 36,487 7.86 7.58
```

We can see that the data categorized in periods with descrete numbers, we can create new factors out of this for the sake of convinience:

`555 Never` + `300 Less than one time per month` + `<= 1 times per week` + `<= 4 times per month` -> `never`
`<= 2 times per week` + `<= 9 times per month` -> 'a little'
`<= 4 times per week` + `<= 15 times per month` -> 'medium'
`<= 5 times per week` + `<= 20 times per month` -> 'most'
`<= 7 times per week` + `<= 31 times per month` -> 'all'

```{r}
data_fruit <- data_fruit %>% mutate(fvgreenCat =
  ifelse(
    fvgreen == 0 | # never
    fvgreen == 1 | # less than one time per week
    fvgreen == 2 | # less than one time per month
    fvgreen == 300 | # less than one time per month
    (fvgreen == 201) | # less than one time pre week
    (fvgreen >= 301 & fvgreen <= 304) # less than 4 times pre week
    ,
    '0. never',
    ifelse(
      (fvgreen >= 202 & fvgreen <= 202) | # <= 2 times per week
      (fvgreen >= 305 & fvgreen <= 309) # <= 9 times per month
      ,
      '1. a little',
      ifelse(
        (fvgreen >= 203 & fvgreen <= 204) | # <= 4 times per week
        (fvgreen >= 310 & fvgreen <= 315) # <= 15 times per month
        ,
        '2. medium',
        ifelse(
          (fvgreen >= 205 & fvgreen <= 205) | # <= 5 times per week
          (fvgreen >= 316 & fvgreen <= 320) # <= 20 times per month
          ,
          '3. most',
          ifelse(
            (fvgreen >= 206 & fvgreen <= 207) | # <= 7 times per week
            (fvgreen == 101) | # <= 7 times per week / 1 times a day
            (fvgreen >= 321 & fvgreen <= 331) # <= 31 times per month
            ,
            '4. all',
            ifelse(
              (fvgreen >= 102 & fvgreen <= 102) | ## twice a day
              (fvgreen >= 208 & fvgreen <= 212) |
              (fvgreen >= 331 & fvgreen <= 340)
              ,
              '5. all+', # (multiple times a day),
              ifelse(
                (fvgreen >= 103 & fvgreen <= 105) | ## 3-5 times a day a day
                (fvgreen >= 213 & fvgreen <= 226) |
                (fvgreen >= 332 & fvgreen <= 364)
                ,
                '6. all++',
                ifelse(
                  (fvgreen >= 106 & fvgreen < 200) |  ## 6+ times a day a day
                  (fvgreen >= 227 & fvgreen < 300) |
                  (fvgreen >= 365 & fvgreen <= 400)
                ,
                '7. all+++',
                'error'
                )
              )
            )
          )
        )
      )
    )
  )
)
```

For sanity check, let's see how many observations were categorized as `error`:

```{r}
# uncomment to see where the error is
# data_fruit %>% filter(fvgreenCat == 'error') %>% group_by(fvgreenCat, fvgreen) %>% summarise(n = n())
data_fruit %>% group_by(fvgreenCat) %>% summarise(n = n())
```
Looks good, all the cases were successfully recategorized.

Now let's build a starndartized barplot with fractions of all categories:

```{r}
ggplot(data = data_fruit, aes(x = genhlth, fill = fvgreenCat)) + geom_bar(position = "fill") +
  labs(title="Proportions of people who eats green vegetables and their general health:") +
  xlab("genertal health (genhlth)") +
  ylab("eating green vegetables (fvgreenCat)") +
  scale_fill_discrete(name = "How often greens consumed")
```
In the graph above, we can see that the `Poor health` category has a lot of people who never eats fruits(`0. never`) - about `35%`, for the contrast `Exellent health` category contains much smaller number of such people - about `15%`. All other subcategories suggest the same conclusion - there is a strong correlation between `general health` and `number of fruits eaten` variables.

The interesting part is the correlation direction for each level:

 - For the `0. never` level vs `genhlth` we see a positive direction of the correlation
 - For the `1. a little` level vs `genhlth` we see no trend at all
 - Starting from the `2. a medium` level vs `genhlth` the trend starts to be negative
 
 Lets plot each of the greens levels correlations to illustrate that:

```{r}
a = c('0. never', '1. a little', '2. medium', '3. most', '4. all', '5. all+',  '6. all++',  '7. all+++')
for(i in a) {
  data_fruit_temp <- data_fruit %>% mutate(fvgreenCatTemp = ifelse(fvgreenCat == i, i, 'other'))
  print(ggplot(data = data_fruit_temp, aes(x = genhlth, fill = fvgreenCatTemp)) + geom_bar(position = "fill"))
}
```

The point where the correlation changes direction might be interesting in further data exploration if we will conduct a controlled experiment.

#### Fruits consumtion  vs General health

We had found the correlation for the vegetables, let's see if there any correlation with for `general health` and `amount of fruits eaten`.
First let's see the data:

```{r}
data_fruit %>% group_by(fruit1) %>% summarise(n = n())
```

As we can see the data encoded exactly the same as the data for the vegetables(`fvgreen`), let apply exactly the same transformation for it:


```{r}
data_fruit <- data_fruit %>% mutate(fruit1Cat =
  ifelse(
    fruit1 == 0 | # never
    fruit1 == 1 | # less than one time per week
    fruit1 == 2 | # less than one time per month
    fruit1 == 300 | # less than one time per month
    (fruit1 == 201) | # less than one time pre week
    (fruit1 >= 301 & fruit1 <= 304) # less than 4 times pre week
    ,
    '0. never',
    ifelse(
      (fruit1 >= 202 & fruit1 <= 202) | # <= 2 times per week
      (fruit1 >= 305 & fruit1 <= 309) # <= 9 times per month
      ,
      '1. a little',
      ifelse(
        (fruit1 >= 203 & fruit1 <= 204) | # <= 4 times per week
        (fruit1 >= 310 & fruit1 <= 315) # <= 15 times per month
        ,
        '2. medium',
        ifelse(
          (fruit1 >= 205 & fruit1 <= 205) | # <= 5 times per week
          (fruit1 >= 316 & fruit1 <= 320) # <= 20 times per month
          ,
          '3. most',
          ifelse(
            (fruit1 >= 206 & fruit1 <= 207) | # <= 7 times per week
            (fruit1 == 101) | # <= 7 times per week / 1 times a day
            (fruit1 >= 321 & fruit1 <= 331) # <= 31 times per month
            ,
            '4. all',
            ifelse(
              (fruit1 >= 102 & fruit1 <= 102) | ## twice a day
              (fruit1 >= 208 & fruit1 <= 212) |
              (fruit1 >= 331 & fruit1 <= 340)
              ,
              '5. all+', # (multiple times a day),
              ifelse(
                (fruit1 >= 103 & fruit1 <= 105) | ## 3-5 times a day a day
                (fruit1 >= 213 & fruit1 <= 226) |
                (fruit1 >= 332 & fruit1 <= 364)
                ,
                '6. all++',
                ifelse(
                  (fruit1 >= 106 & fruit1 < 200) |  ## 6+ times a day a day
                  (fruit1 >= 227 & fruit1 < 300) |
                  (fruit1 >= 365 & fruit1 <= 400)
                ,
                '7. all+++',
                'error'
                )
              )
            )
          )
        )
      )
    )
  )
)
```

Now let's check if there any errors:

```{r}
# uncomment to see where the error is
# data_fruit %>% filter(fruit1Cat == 'error') %>% group_by(fruit1Cat, fruit1) %>% summarise(n = n())
data_fruit %>% group_by(fruit1Cat) %>% summarise(n = n())
```

All the cases were successfully recategorized - no errors found. Now let's build a starndartized barplot with fractions of all levels:

```{r}
ggplot(data = data_fruit, aes(x = genhlth, fill = fruit1Cat)) + geom_bar(position = "fill") +
  labs(title="Proportions of people who eats fruits and their general health:") +
  xlab("genertal health (genhlth)") +
  ylab("eating fruits (fruit1Cat)") +
  scale_fill_discrete(name = "How often fruits consumed")
```

The difference in the distributions among levels again suggests a strong correlation, not as strong as with greens though (about `10%` difference for the extremes - `0. never` vs `7. all+++`).

Let's see if there and when the correlation direction changes:

```{r}
a = c('0. never', '1. a little', '2. medium', '3. most', '4. all', '5. all+',  '6. all++',  '7. all+++')
for(i in a) {
  data_fruit_temp <- data_fruit %>% mutate(fruit1CatTemp = ifelse(fruit1Cat == i, i, 'other'))
  print(ggplot(data = data_fruit_temp, aes(x = genhlth, fill = fruit1CatTemp)) + geom_bar(position = "fill"))
}
```

Interestingly, the trend starts to change a bit later - in the `3. most` level. Just like with greens it stays negative after the first change point.

#### Recap:

Data analysis shows a strong correlation between the `eating green vegetables` and the `general health` variables as well as for the `eating fruits` and the `general health` ones.
The results are a bit surprising for the author as he expected the correlation for the `fruit consumption`/`general health` variables, when the fruit consumption goes beyond some amount per day, to change the direction again - thus change the direction twice. This was not observed during the analysis.
